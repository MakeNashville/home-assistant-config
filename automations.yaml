- id: '1721495372161'
  alias: Lifecycle Print Progress
  triggers:
  - entity_id:
    - sensor.kiwi_current_layer
    - sensor.papaya_current_layer
    - sensor.mango_current_layer
    - sensor.strawberry_current_layer
    - sensor.huckleberry_current_layer
    - sensor.pineapple_current_layer
    for:
      seconds: 1
    to:
    - '2'
    trigger: state
  - entity_id:
    - sensor.kiwi_current_layer
    - sensor.papaya_current_layer
    - sensor.mango_current_layer
    - sensor.strawberry_current_layer
    - sensor.huckleberry_current_layer
    - sensor.pineapple_current_layer
    for:
      seconds: 1
    to:
    - '10'
    trigger: state
  - entity_id:
    - sensor.kiwi_print_progress
    - sensor.papaya_print_progress
    - sensor.mango_print_progress
    - sensor.strawberry_print_progress
    - sensor.huckleberry_print_progress
    - sensor.pineapple_print_progress
    for:
      seconds: 1
    to:
    - '50'
    trigger: state
  - entity_id:
    - sensor.kiwi_print_progress
    - sensor.papaya_print_progress
    - sensor.mango_print_progress
    - sensor.strawberry_print_progress
    - sensor.huckleberry_print_progress
    - sensor.pineapple_print_progress
    for:
      seconds: 1
    to:
    - '90'
    trigger: state
  actions:
  - variables:
      printer: '{{trigger.entity_id.split(''_'')[0].split(''.'')[1]}}'
      display_name: '{{states("sensor."+printer+"_display_name") }}'
      object_name: '{{states("sensor."+printer+"_object") }}'
  - data:
      target: "{{ (states('input_text.slack_channel_3dprint') or '#sandbox') }}"
      message: ":speech_balloon:{% if display_name != object_name %}@{{display_name}},
        {% endif %}{{object_name}} is {{ states('sensor.'+printer+'_print_progress',
        with_unit=True)}} complete and on layer {{ states('sensor.'+printer+'_current_layer')
        }} of {{ states('sensor.'+printer+'_total_layer_count') }}. {{states('input_text.'+printer+'_stream')}}"
      data:
        username: '{{ printer | capitalize }}'
        icon: '{{ ''kiwifruit'' if printer == ''kiwi'' else printer }}'
    action: notify.make_nashville
  mode: single
- id: '1722144402850'
  alias: Lifecycle Print Starting
  triggers:
  - entity_id: &bambu_lab_printers
    - sensor.mango_print_status
    - sensor.kiwi_print_status
    - sensor.strawberry_print_status
    - sensor.papaya_print_status
    - sensor.huckleberry_print_status
    to:
    - running
    for:
      seconds: 10
    trigger: state
    from:
    - prepare
  - entity_id:
    - sensor.pineapple_print_status
    to:
    - printing
    from:
    - idle
    for:
      seconds: 10
    trigger: state
  actions:
  - variables:
      printer: '{{trigger.entity_id.split(''_'')[0].split(''.'')[1]}}'
      display_name: '{{states("sensor."+printer+"_display_name")}}'
      object_name: '{{states("sensor."+printer+"_object") }}'
      end_dt: '{% set e = as_datetime(states("sensor."+printer+"_end_time"), none)
        %}{% if e %}{{ e }}{% else %}{% set s = states("sensor."+printer+"_print_time_left")|int(0)
        %}{% if s > 0 %}{{ now() + timedelta(seconds=s) }}{% endif %}{% endif %}'
      print_weight: '{{states("sensor."+printer+"_print_weight", with_unit=True) if
        states("sensor."+printer+"_print_weight") not in ["unknown","unavailable",""]
        else ""}}'
      total_layers: '{{states("sensor."+printer+"_total_layer_count") if states("sensor."+printer+"_total_layer_count")
        not in ["unknown","unavailable",""] else states("sensor."+printer+"_total_layers")
        if states("sensor."+printer+"_total_layers") not in ["unknown","unavailable",""]
        else ""}}'
      bed_type: '{{states("sensor."+printer+"_print_bed_type") if states("sensor."+printer+"_print_bed_type")
        not in ["unknown","unavailable",""] else ""}}'
  - data:
      target: "{{ (states('input_text.slack_channel_3dprint') or '#sandbox') }}"
      message: ":printer:{% if display_name != object_name %}@{{display_name}},
        {% endif %}{{object_name}} is starting!{% if print_weight %} Printing {{print_weight}}{% endif
        %}{% if total_layers %} over {{total_layers}} layers{% endif %}{% if bed_type
        %} on a {{bed_type}}{% endif %}.{% if end_dt %} {% set secs = (as_timestamp(end_dt)
        - as_timestamp(now())) | int(0) %}{% set h = secs // 3600 %}{% set m = (secs
        % 3600) // 60 %}{{ h }}h {{ '%02d' | format(m) }}m (ends at {{ as_timestamp(end_dt)
        | timestamp_custom('%I:%M %p') }}){% endif %} {{states('input_text.'+printer+'_stream')}}"
      data:
        username: '{{ printer | capitalize }}'
        icon: '{{ ''kiwifruit'' if printer == ''kiwi'' else printer }}'
    action: notify.make_nashville
  - if:
    - condition: template
      value_template: "{{ printer == 'pineapple' }}"
    then:
    - action: input_text.set_value
      target:
        entity_id: input_text.pineapple_last_job
      data:
        value: "{{ states('sensor.pineapple_current_object') }}"
  mode: parallel
  max: 4
- id: '1722191155564'
  alias: Lifecycle Print Finished
  triggers:
  - entity_id: *bambu_lab_printers
    to:
    - finish
    for:
      seconds: 5
    trigger: state
    from:
    - running
  - entity_id:
    - sensor.pineapple_print_status
    to:
    - completed
    for:
      seconds: 5
    trigger: state
    from:
    - printing
  actions:
  - variables:
      printer: '{{trigger.entity_id.split(''_'')[0].split(''.'')[1]}}'
      display_name: '{{states("sensor."+printer+"_last_display_name") }}'
      object_name: '{{states("sensor."+printer+"_last_object") }}'
      job_secs: '{{states("sensor."+printer+"_print_job_time") | int(0)}}'
      job_time_str: '{%- set h = (job_secs // 3600) | int %}{%- set m = ((job_secs
        % 3600) // 60) | int %}{{ h }}h {{ "%02d" | format(m) }}m'
      used_weight: '{{states("sensor."+printer+"_used_material_weight", with_unit=True)
        if states("sensor."+printer+"_used_material_weight") not in ["unknown","unavailable"]
        else ""}}'
  - data:
      target: "{{ (states('input_text.slack_channel_3dprint') or '#sandbox') }}"
      message: ":white_check_mark:{% if display_name != object_name %}@{{display_name}}, {% endif %}{{object_name}}
        finished in {{job_time_str}}{% if used_weight %}, used {{used_weight}}{% endif
        %}! Please pick up your print and cleanup the space. {{states('input_text.'+printer+'_stream')}}"
      data:
        username: '{{ printer | capitalize }}'
        icon: '{{ ''kiwifruit'' if printer == ''kiwi'' else printer }}'
    action: notify.make_nashville
  mode: parallel
  max: 4
- id: '1722194364076'
  alias: Lifecycle Print Stopped
  triggers:
  - entity_id: *bambu_lab_printers
    to:
    - failed
    for:
      seconds: 10
    trigger: state
    from:
    - running
  - entity_id:
    - sensor.pineapple_print_status
    to:
    - stopped
    for:
      seconds: 10
    trigger: state
    from:
    - printing
  actions:
  - variables:
      printer: '{{trigger.entity_id.split(''_'')[0].split(''.'')[1]}}'
      display_name: '{{states("sensor."+printer+"_display_name") }}'
      object_name: '{{states("sensor."+printer+"_object") }}'
      progress: '{{states("sensor."+printer+"_print_progress") | int(0)}}'
  - data:
      target: "{{ (states('input_text.slack_channel_3dprint') or '#sandbox') }}"
      message: ':stop_button:{% if display_name != object_name %}@{{display_name}}, {% endif
        %}{{object_name}} stopped at {{progress}}%. Check the print room for more
        details on what happened. {{states(''input_text.''+printer+''_stream'')}}'
      data:
        username: '{{ printer | capitalize }}'
        icon: '{{ ''kiwifruit'' if printer == ''kiwi'' else printer }}'
    action: notify.make_nashville
  mode: parallel
  max: 4
- id: '1740355200000'
  alias: Lifecycle Print Error
  triggers:
  - entity_id: &all_printers
    - sensor.mango_print_status
    - sensor.kiwi_print_status
    - sensor.strawberry_print_status
    - sensor.papaya_print_status
    - sensor.huckleberry_print_status
    - sensor.pineapple_print_status
    to:
    - error
    for:
      seconds: 10
    trigger: state
  actions:
  - variables:
      printer: '{{trigger.entity_id.split(''_'')[0].split(''.'')[1]}}'
      display_name: '{{states("sensor."+printer+"_display_name") }}'
      object_name: '{{states("sensor."+printer+"_object") }}'
      error_info: '{{states("sensor."+printer+"_print_error") if states("sensor."+printer+"_print_error")
        not in ["unknown","unavailable",""] else ""}}'
  - data:
      target: "{{ (states('input_text.slack_channel_3dprint') or '#sandbox') }}"
      message: ':rotating_light:{% if display_name != object_name %}@{{display_name}}, {% endif
        %}{{object_name}} encountered an error{% if error_info %}: {{error_info}}{%
        endif %}. Check the printer immediately. {{states(''input_text.''+printer+''_stream'')}}'
      data:
        username: '{{ printer | capitalize }}'
        icon: '{{ ''kiwifruit'' if printer == ''kiwi'' else printer }}'
    action: notify.make_nashville
  mode: parallel
  max: 4
- id: '1740400001000'
  alias: Lifecycle Print Paused
  triggers:
  - entity_id: *bambu_lab_printers
    to:
    - pause
    for:
      seconds: 10
    trigger: state
    from:
    - running
  - entity_id:
    - sensor.pineapple_print_status
    to:
    - paused
    for:
      seconds: 10
    trigger: state
    from:
    - printing
  actions:
  - variables:
      printer: '{{trigger.entity_id.split(''_'')[0].split(''.'')[1]}}'
      display_name: '{{states("sensor."+printer+"_display_name") }}'
      object_name: '{{states("sensor."+printer+"_object") }}'
      progress: '{{states("sensor."+printer+"_print_progress") | int(0)}}'
  - data:
      target: "{{ (states('input_text.slack_channel_3dprint') or '#sandbox') }}"
      message: ':double_vertical_bar:{% if display_name != object_name %}@{{display_name}}, {% endif
        %}{{object_name}} paused at {{progress}}%. {{states(''input_text.''+printer+''_stream'')}}'
      data:
        username: '{{ printer | capitalize }}'
        icon: '{{ ''kiwifruit'' if printer == ''kiwi'' else printer }}'
    action: notify.make_nashville
  mode: parallel
  max: 4
- id: '1722445886802'
  alias: Roundup
  triggers:
  - hours: /2
    trigger: time_pattern
  conditions:
  - condition: template
    value_template: "{{ now().hour >= 7 and now().hour < 22 }}"
  - condition: template
    value_template: |-
      {% set printers = ['kiwi','mango','papaya','strawberry','huckleberry','pineapple'] %}
      {% set not_printing = ['unavailable','idle','offline','finish','failed','completed','stopped','error','unknown','prepare'] %}
      {% set ns = namespace(active=false) %}
      {% for p in printers %}{% if states('sensor.' ~ p ~ '_print_status') not in not_printing %}{% set ns.active = true %}{% endif %}{% endfor %}
      {{ ns.active }}
  actions:
  - data:
      target: "{{ (states('input_text.slack_channel_3dprint') or '#sandbox') }}"
      data:
        username: Fruitbasket
        icon: basket
      message: |-
        {%- set printers = [
          {"id":"kiwi","emoji":":kiwifruit:"},
          {"id":"mango","emoji":":mango:"},
          {"id":"papaya","emoji":":papaya:"},
          {"id":"strawberry","emoji":":strawberry:"},
          {"id":"huckleberry","emoji":":huckleberry:"},
          {"id":"pineapple","emoji":":pineapple:"},
        ] %}
        {%- set not_printing = ['unavailable','idle','offline','finish','failed','completed','stopped','error','unknown','prepare'] %}
        {%- set ns = namespace(active=0) %}
        {%- for p in printers %}
          {%- if states('sensor.' ~ p.id ~ '_print_status') not in not_printing %}
            {%- set ns.active = ns.active + 1 %}
          {%- endif %}
        {%- endfor %}
        {%- macro line(p) %}
          {%- set st = states('sensor.' ~ p.id ~ '_print_status') %}
          {%- set display = states('sensor.' ~ p.id ~ '_display_name') %}
          {%- set obj = states('sensor.' ~ p.id ~ '_object') %}
          {%- set display = p.id | capitalize if display in ['unknown','unavailable',''] else display %}
          {%- set obj = display if obj in ['unknown','unavailable',''] else obj %}
          {%- set status_labels = {
            'idle': 'Ready',
            'prepare': 'Preparing',
            'finish': 'Finished',
            'completed': 'Finished',
            'failed': 'Stopped',
            'stopped': 'Stopped',
            'error': 'Error',
            'pause': 'Paused',
            'paused': 'Paused',
            'offline': 'Offline',
            'unavailable': 'Offline',
            'unknown': 'Offline',
          } %}
          {%- if st not in not_printing %}
            {%- set progress = states('sensor.' ~ p.id ~ '_print_progress') %}
            {%- set _end_raw = as_datetime(states('sensor.' ~ p.id ~ '_end_time'), none) %}
            {%- set _tl = states('sensor.' ~ p.id ~ '_print_time_left') | int(0) %}
            {%- set end_dt = _end_raw if _end_raw else (now() + timedelta(seconds=_tl) if _tl > 0 else none) %}
            {%- set verb = 'paused on' if st in ['pause', 'paused'] else 'printing' %}
            {{- p.emoji }} @{{ display }} {{ verb }} {{ obj }} — {{ progress }}%{%- if end_dt %}, ends {{ as_timestamp(end_dt) | timestamp_custom('%I:%M %p') }}{%- endif %}
          {%- else %}
            {{- p.emoji }} {{ status_labels.get(st, st | capitalize) }}
          {%- endif %}
        {%- endmacro %}
        Bi-hourly roundup — {{ ns.active }} printer{{ 's' if ns.active != 1 else '' }} active
        {%- for p in printers %}
        {{ line(p) }}
        {%- endfor %}
    action: notify.make_nashville
    enabled: true
  mode: single
- id: '1763702620736'
  alias: Kaeser Event notifier
  triggers:
  - type: voltage
    device_id: 475db66f7f774cdfa45430706b46ee05
    entity_id: a04620ed092035484c42bbc3ec1a8e07
    domain: sensor
    trigger: device
    above: 130
    for:
      minutes: 2
  actions:
  - action: notify.mobile_app_tim_krentz_iphone
    data:
      message: Kaeser Overpressurization Event!
  - action: notify.make_nashville
    data:
      target: "{{ (states('input_text.slack_channel_facilities') or '#sandbox') }}"
      message: ":rotating_light: Kaeser Overpressurization Event detected!"
      data:
        icon: warning
        username: Kaeser
  mode: single
- id: '1767137243013'
  alias: Stripe – 3D Print Filament Purchase
  triggers:
  - webhook_id: !secret stripe_webhook_id
    trigger: webhook
    allowed_methods:
    - POST
    local_only: false
  conditions:
  - condition: template
    value_template: >
      {% set obj = trigger.json.data.object | default({}) %}
      {% set desc = obj.description | default('') | replace('\u2013', '-') | replace('\u2014', '-') %}
      {{ trigger.json.livemode | default(false)
         and '3D Print Filament' in desc
         and 'Self Service' in desc }}
  actions:
  - action: notify.filament_purchases_log
    data:
      message: >-
        {{ now().isoformat() }},{{ (trigger.json.data.object.amount | default(0)) / 100 | round(2) }},"{{ trigger.json.data.object.description | default('') }}"
  - action: light.turn_on
    target:
      entity_id: light.filament_store_light
    data:
      rgb_color:
      - 11
      - 199
      - 0
      brightness_pct: 100
  - delay:
      seconds: 30
  - action: light.turn_on
    target:
      entity_id: light.filament_store_light
    data:
      rgb_color:
      - 255
      - 158
      - 0
      brightness_pct: 10
      transition: 32
  mode: single
- id: backup_config_github
  alias: Backup Config to GitHub
  description: Automatically backup HA config to GitHub then reload
  triggers:
  - at: 03:00:00
    trigger: time
  - trigger: homeassistant
    event: start
  actions:
  - sequence:
    - action: shell_command.clear_entity_list
    - action: notify.entity_list_file
      data:
        message: >-
          {% for s in states | sort(attribute='entity_id') -%}
          {{ s.entity_id }} | {{ s.name }}
          {% endfor %}
    - action: hassio.addon_stdin
      data:
        addon: core_ssh
        input: /config/git_backup.sh
    - action: notify.make_nashville
      data:
        target: "{{ (states('input_text.slack_channel_deployment') or '#deployment-feed') }}"
        message: ":white_check_mark: Config backup to GitHub completed. Reloading HA at {{ now().strftime('%a %b %-d %-I:%M %p') }}."
        data:
          username: HA Backup
          icon: floppy_disk
    - delay:
        seconds: 5
    - action: automation.reload
    - action: script.reload
    - action: homeassistant.reload_core_config
  mode: single

- id: facilities_pulse_smart_alert
  alias: Facilities Pulse — Smart Alert
  triggers:
  - trigger: numeric_state
    entity_id:
    - sensor.air_quality_temperature
    - sensor.ceramics_climate_sensor_temperature
    - sensor.woodshop_climate_sensor_temperature
    - sensor.front_hallway_climate_sensor_temperature
    - sensor.network_closet_climate_sensor_temperature
    below: 62
    for:
      minutes: 5
  - trigger: numeric_state
    entity_id:
    - sensor.air_quality_temperature
    - sensor.ceramics_climate_sensor_temperature
    - sensor.woodshop_climate_sensor_temperature
    - sensor.front_hallway_climate_sensor_temperature
    - sensor.network_closet_climate_sensor_temperature
    above: 82
    for:
      minutes: 5
  - trigger: state
    entity_id:
    - sensor.air_quality_temperature
    - sensor.ceramics_climate_sensor_temperature
    - sensor.woodshop_climate_sensor_temperature
    - sensor.front_hallway_climate_sensor_temperature
    - sensor.network_closet_climate_sensor_temperature
  - trigger: numeric_state
    entity_id: sensor.kaeser_monitor_system_pressure
    below: 80
    for:
      minutes: 5
  - trigger: state
    entity_id: sensor.total_power_alarm_power_failure_alarm
  - trigger: state
    entity_id: binary_sensor.water_leak_sensor
  conditions:
  - condition: template
    value_template: >
      {{ (this.attributes.last_triggered is none or
          (now() - this.attributes.last_triggered).total_seconds() > 900)
         and (trigger.platform == 'numeric_state' or
              trigger.entity_id in ['sensor.total_power_alarm_power_failure_alarm', 'binary_sensor.water_leak_sensor'] or
              (trigger.from_state.state | float(0) - trigger.to_state.state | float(0)) | abs > 5) }}
  actions:
  - action: notify.make_nashville
    data:
      target: "{{ (states('input_text.slack_channel_facilities') or '#sandbox') }}"
      data:
        icon: warning
        username: Facilities Pulse
      message: |
        :warning: *Facilities Alert* — {{ trigger.to_state.name }} {{ trigger.to_state.state }}{{ trigger.to_state.attributes.unit_of_measurement | default('') }}
        *{{ now().strftime('%a, %b %-d  %-I:%M %p') }}*

        *:thermometer: Environment*
        {% set ns = namespace(count=0) -%}
        {% for device_id in label_devices('facilities_pulse') -%}
        {% set entities = device_entities(device_id) -%}
        {% set temp_e = entities | reject('search','display_temperature') | select('search','temperature') | first | default(none) -%}
        {% set hum_e  = entities | select('search','humidity') | first | default(none) -%}
        {% if temp_e and states(temp_e) not in ['unknown','unavailable',none] -%}
        {% set ns.count = ns.count + 1 -%}
        {% set t = states(temp_e) | float(0) -%}
        {% set icon = ':green_circle:' if t >= 65 and t <= 80 else ':yellow_circle:' if t >= 60 and t < 65 or t > 80 and t <= 85 else ':red_circle:' -%}
        {{ icon }} {{ "%-17s"|format(area_name(temp_e)|default('Unknown')) }} {{ "%5.1f°F"|format(t) }}  {{ states(hum_e)|float(0)|round(0)|int }}%
        {% endif -%}
        {% endfor -%}
        {% if ns.count == 0 %}:warning: No sensors found — check the facilities_pulse label{% endif -%}
        :partly_sunny: {{ "%-17s"|format('Outside') }} {{ "%5.1f°F"|format(state_attr('weather.forecast_home','temperature')|float(0)) }}  {{ state_attr('weather.forecast_home','humidity')|int }}%

        *:gear: Systems*
        {% set pwr = states('sensor.total_power_alarm_power_failure_alarm') | lower -%}
        {{ ':white_check_mark:' if pwr == 'ok' else ':warning:' }} Power:               {{ pwr | capitalize }}
        {% set leak = states('binary_sensor.water_leak_sensor') -%}
        {{ ':white_check_mark:' if leak == 'off' else ':droplet:' }} Exec Bathroom:       {{ state_translated('binary_sensor.water_leak_sensor') }}
        :large_blue_circle: Kaeser:              {{ states('sensor.kaeser_monitor_system_pressure') | float(0) | round(1) }} psi

        *:dash: 3D Print Room*
        {% set aq = states('sensor.air_quality_overall_status') -%}
        {% set aq_icon = ':green_circle:' if aq == 'Good' else ':yellow_circle:' if aq == 'Moderate' else ':large_orange_circle:' if aq == 'Poor' else ':red_circle:' -%}
        {{ aq_icon }} Air Quality: {{ aq }}
        CO₂: {{ states('sensor.air_quality_carbon_dioxide') }} ppm  |  VOC: {{ states('sensor.air_quality_voc_index') }}  |  PM2.5: {{ states('sensor.air_quality_pm2_5') | float(0) | round(1) }} ug/m3
  mode: queued
  max: 2
- id: facilities_pulse_verbose
  alias: Facilities Pulse — Verbose
  triggers:
  - trigger: time_pattern
    hours: /1
  conditions:
  - condition: template
    value_template: "{{ is_state('input_boolean.facilities_pulse_verbose', 'on') }}"
  actions:
  - action: notify.make_nashville
    data:
      target: "{{ (states('input_text.slack_channel_facilities') or '#sandbox') }}"
      data:
        icon: information_source
        username: Facilities Pulse
      message: |
        *{{ now().strftime('%a, %b %-d  %-I:%M %p') }}*

        *:thermometer: Environment*
        {% set ns = namespace(count=0) -%}
        {% for device_id in label_devices('facilities_pulse') -%}
        {% set entities = device_entities(device_id) -%}
        {% set temp_e = entities | reject('search','display_temperature') | select('search','temperature') | first | default(none) -%}
        {% set hum_e  = entities | select('search','humidity') | first | default(none) -%}
        {% if temp_e and states(temp_e) not in ['unknown','unavailable',none] -%}
        {% set ns.count = ns.count + 1 -%}
        {% set t = states(temp_e) | float(0) -%}
        {% set icon = ':green_circle:' if t >= 65 and t <= 80 else ':yellow_circle:' if t >= 60 and t < 65 or t > 80 and t <= 85 else ':red_circle:' -%}
        {{ icon }} {{ "%-17s"|format(area_name(temp_e)|default('Unknown')) }} {{ "%5.1f°F"|format(t) }}  {{ states(hum_e)|float(0)|round(0)|int }}%
        {% endif -%}
        {% endfor -%}
        {% if ns.count == 0 %}:warning: No sensors found — check the facilities_pulse label{% endif -%}
        :partly_sunny: {{ "%-17s"|format('Outside') }} {{ "%5.1f°F"|format(state_attr('weather.forecast_home','temperature')|float(0)) }}  {{ state_attr('weather.forecast_home','humidity')|int }}%

        *:gear: Systems*
        {% set pwr = states('sensor.total_power_alarm_power_failure_alarm') | lower -%}
        {{ ':white_check_mark:' if pwr == 'ok' else ':warning:' }} Power:               {{ pwr | capitalize }}
        {% set leak = states('binary_sensor.water_leak_sensor') -%}
        {{ ':white_check_mark:' if leak == 'off' else ':droplet:' }} Exec Bathroom:       {{ state_translated('binary_sensor.water_leak_sensor') }}
        :large_blue_circle: Kaeser:              {{ states('sensor.kaeser_monitor_system_pressure') | float(0) | round(1) }} psi

        *:dash: 3D Print Room*
        {% set aq = states('sensor.air_quality_overall_status') -%}
        {% set aq_icon = ':green_circle:' if aq == 'Good' else ':yellow_circle:' if aq == 'Moderate' else ':large_orange_circle:' if aq == 'Poor' else ':red_circle:' -%}
        {{ aq_icon }} Air Quality: {{ aq }}
        CO₂: {{ states('sensor.air_quality_carbon_dioxide') }} ppm  |  VOC: {{ states('sensor.air_quality_voc_index') }}  |  PM2.5: {{ states('sensor.air_quality_pm2_5') | float(0) | round(1) }} ug/m3
  mode: single
- id: '1740400000000'
  alias: Gadget AI Failure Detection
  description: Receives OctoEverywhere Gadget webhooks for Bambu Lab printers
  triggers:
  - trigger: webhook
    webhook_id: !secret octoeverywhere_webhook_id
    allowed_methods:
    - POST
    local_only: false
  conditions:
  - condition: template
    value_template: >
      {{ trigger.json.EventType in [7, 8]
         and trigger.json.PrinterName is defined
         and trigger.json.PrinterName | lower in ['kiwi', 'mango', 'papaya', 'strawberry', 'huckleberry'] }}
  actions:
  - variables:
      event_type: '{{ trigger.json.EventType }}'
      printer_name: '{{ trigger.json.PrinterName }}'
      printer_id: '{{ trigger.json.PrinterName | lower }}'
      file_name: '{{ trigger.json.FileName | default("") }}'
      progress: '{{ trigger.json.Progress | default(0) }}'
      stream_url: '{{ states("input_text." + printer_id + "_stream") }}'
  - action: notify.make_nashville
    data:
      target: "{{ (states('input_text.slack_channel_3dprint') or '#sandbox') }}"
      message: '{% if event_type == 8 %}:rotating_light: Gadget paused {{ printer_name }} after
        detecting a failure{% else %}:warning: Gadget detected a possible failure on {{
        printer_name }}{% endif %}{% if file_name %} printing {{ file_name }}{% endif
        %} ({{ progress }}% complete). {{ stream_url }}'
      data:
        username: Gadget
        icon: robot_face
  mode: parallel
  max: 5
- id: '1769999000001'
  alias: Purge Kaeser Pressure History
  description: Keep only 3 days of Kaeser pressure data to limit DB growth
  triggers:
  - trigger: time
    at: '03:30:00'
  actions:
  - action: recorder.purge_entities
    data:
      entity_id:
      - sensor.kaeser_monitor_system_pressure
      keep_days: 3
  mode: single
- id: '1740500000001'
  alias: Lifecycle Printer Offline
  triggers:
  - entity_id: *all_printers
    to:
    - unavailable
    for:
      minutes: 5
    trigger: state
  actions:
  - variables:
      printer: '{{trigger.entity_id.split(''_'')[0].split(''.'')[1]}}'
  - data:
      target: "{{ (states('input_text.slack_channel_3dprint') or '#sandbox') }}"
      message: ':warning: {{ printer | capitalize }} has gone offline.'
      data:
        username: '{{ printer | capitalize }}'
        icon: '{{ ''kiwifruit'' if printer == ''kiwi'' else printer }}'
    action: notify.make_nashville
  mode: parallel
  max: 6
- id: '1740600000001'
  alias: Weekly Print Summary
  description: Posts 7-day print totals to #3dprint-info every Sunday at 9am
  triggers:
  - trigger: time
    at: '09:00:00'
  conditions:
  - condition: template
    value_template: '{{ now().weekday() == 6 }}'
  actions:
  - action: notify.make_nashville
    data:
      target: "{{ (states('input_text.slack_channel_3dprint') or '#sandbox') }}"
      data:
        username: Fruitbasket
        icon: basket
      message: |-
        {%- set printers = [
          {"id":"kiwi","emoji":":kiwifruit:"},
          {"id":"mango","emoji":":mango:"},
          {"id":"papaya","emoji":":papaya:"},
          {"id":"strawberry","emoji":":strawberry:"},
          {"id":"huckleberry","emoji":":huckleberry:"},
          {"id":"pineapple","emoji":":pineapple:"},
        ] %}
        {%- set ns = namespace(total_ok=0, total_fail=0) %}
        :bar_chart: Weekly Print Summary (last 7 days)
        {%- for p in printers %}
          {%- set ok = states('sensor.' ~ p.id ~ '_prints_completed_week') | int(0) %}
          {%- set fail = states('sensor.' ~ p.id ~ '_prints_failed_week') | int(0) %}
          {%- set ns.total_ok = ns.total_ok + ok %}
          {%- set ns.total_fail = ns.total_fail + fail %}
        {{ p.emoji }} {{ p.id | capitalize }}: {{ ok }} :white_check_mark:  {{ fail }} :x:
        {%- endfor %}
        ──────────────────────
        Total: {{ ns.total_ok }} :white_check_mark:  {{ ns.total_fail }} :x:
  mode: single
- id: '1740600000002'
  alias: Air Quality Alert
  description: Notify #facilities-feed when 3D print room air quality degrades or recovers
  triggers:
  - trigger: state
    entity_id: sensor.air_quality_overall_status
    to:
    - Poor
    - Dangerous
    for:
      minutes: 3
    id: degraded
  - trigger: state
    entity_id: sensor.air_quality_overall_status
    to:
    - Good
    - Moderate
    from:
    - Poor
    - Dangerous
    for:
      minutes: 5
    id: recovered
  actions:
  - variables:
      co2: '{{ states("sensor.air_quality_carbon_dioxide") }}'
      voc: '{{ states("sensor.air_quality_voc_index") }}'
      nox: '{{ states("sensor.air_quality_nox_index") }}'
      pm25: '{{ states("sensor.air_quality_pm2_5") }}'
      status: '{{ states("sensor.air_quality_overall_status") }}'
  - choose:
    - conditions:
      - condition: trigger
        id: degraded
      sequence:
      - action: notify.make_nashville
        data:
          target: "{{ (states('input_text.slack_channel_facilities') or '#sandbox') }}"
          message: >
            {% if status == 'Dangerous' %}:no_entry:{% else %}:warning:{% endif %} *3D Print Room Air Quality: {{ status }}*
            CO2: {{ co2 }} ppm | VOC: {{ voc }} | NOx: {{ nox }} | PM2.5: {{ pm25 }} ug/m3.
            {% if status == 'Dangerous' %}Ventilate immediately — stop printing if possible.{% else %}Increase ventilation. Open doors or windows.{% endif %}
            {% set not_printing = ['unavailable','idle','offline','finish','failed','completed','stopped','error','unknown','prepare'] -%}
            {% set ns = namespace(active=[]) -%}
            {% for p in ['kiwi','mango','papaya','strawberry','huckleberry','pineapple'] -%}
            {% if states('sensor.' ~ p ~ '_print_status') not in not_printing -%}
            {% set ns.active = ns.active + [p | capitalize] -%}
            {% endif -%}
            {% endfor -%}
            :printer: Printers running: {{ ns.active | join(', ') if ns.active else 'none' }}
          data:
            username: Air Quality
            icon: air_filter
    - conditions:
      - condition: trigger
        id: recovered
      sequence:
      - action: notify.make_nashville
        data:
          target: "{{ (states('input_text.slack_channel_facilities') or '#sandbox') }}"
          message: ':white_check_mark: 3D print room air quality has returned to {{ status }}. CO2: {{ co2 }} ppm | VOC: {{ voc }} | PM2.5: {{ pm25 }} ug/m3.'
          data:
            username: Air Quality
            icon: air_filter
  mode: single
- id: initialize_slack_channels
  alias: Initialize Slack Channel Defaults
  description: Sets default Slack channel values on first start when entities are empty
  triggers:
  - trigger: homeassistant
    event: start
  conditions:
  - condition: template
    value_template: "{{ states('input_text.slack_channel_3dprint') == '' }}"
  actions:
  - action: input_text.set_value
    target:
      entity_id: input_text.slack_channel_3dprint
    data:
      value: '#3dprint-info'
  - action: input_text.set_value
    target:
      entity_id: input_text.slack_channel_facilities
    data:
      value: '#facilities-feed'
  - action: input_text.set_value
    target:
      entity_id: input_text.slack_channel_deployment
    data:
      value: '#deployment-feed'
  mode: single

- id: lifecycle_multi_printer_offline
  alias: Lifecycle Multi-Printer Offline — Network/Power Alert
  triggers:
  - entity_id: *all_printers
    to:
    - unavailable
    for:
      minutes: 5
    trigger: state
  conditions:
  - condition: template
    value_template: >
      {% set printers = ['kiwi','mango','papaya','strawberry','huckleberry','pineapple'] %}
      {% set ns = namespace(offline=0) %}
      {% for p in printers %}
        {% if states('sensor.' ~ p ~ '_print_status') in ['unavailable','unknown','offline'] %}
          {% set ns.offline = ns.offline + 1 %}
        {% endif %}
      {% endfor %}
      {{ ns.offline >= 3 }}
  actions:
  - action: notify.make_nashville
    data:
      target: "{{ (states('input_text.slack_channel_facilities') or '#sandbox') }}"
      message: >
        {% set printers = ['kiwi','mango','papaya','strawberry','huckleberry','pineapple'] %}
        {% set ns = namespace(offline=0, names=[]) %}
        {% for p in printers %}
          {% if states('sensor.' ~ p ~ '_print_status') in ['unavailable','unknown','offline'] %}
            {% set ns.offline = ns.offline + 1 %}
            {% set ns.names = ns.names + [p | capitalize] %}
          {% endif %}
        {% endfor %}
        :warning: {{ ns.offline }} printers offline simultaneously — possible network or power issue.
        Offline: {{ ns.names | join(', ') }}
      data:
        username: Fruitbasket
        icon: warning
  mode: single
