- id: '1721495372161'
  alias: Lifecycle Print Progress
  description: ''
  triggers:
  - entity_id:
    - sensor.kiwi_current_layer
    - sensor.papaya_current_layer
    - sensor.mango_current_layer
    - sensor.strawberry_current_layer
    - sensor.huckleberry_current_layer
    - sensor.pineapple_current_layer
    for:
      hours: 0
      minutes: 0
      seconds: 1
    to:
    - '2'
    trigger: state
  - entity_id:
    - sensor.kiwi_current_layer
    - sensor.papaya_current_layer
    - sensor.mango_current_layer
    - sensor.strawberry_current_layer
    - sensor.huckleberry_current_layer
    - sensor.pineapple_current_layer
    for:
      hours: 0
      minutes: 0
      seconds: 1
    to:
    - '10'
    trigger: state
  - entity_id:
    - sensor.kiwi_print_progress
    - sensor.papaya_print_progress
    - sensor.mango_print_progress
    - sensor.strawberry_print_progress
    - sensor.huckleberry_print_progress
    - sensor.pineapple_print_progress
    for:
      hours: 0
      minutes: 0
      seconds: 1
    to:
    - '50'
    trigger: state
  - entity_id:
    - sensor.kiwi_print_progress
    - sensor.papaya_print_progress
    - sensor.mango_print_progress
    - sensor.strawberry_print_progress
    - sensor.huckleberry_print_progress
    - sensor.pineapple_print_progress
    for:
      hours: 0
      minutes: 0
      seconds: 1
    to:
    - '90'
    trigger: state
  conditions: []
  actions:
  - variables:
      printer: '{{trigger.entity_id.split(''_'')[0].split(''.'')[1]}}'
      display_name: '{{states("sensor."+printer+"_display_name") }}'
      object_name: '{{states("sensor."+printer+"_object") }}'
  - data:
      target: '#3dprint-info'
      message: "\U0001F4AC {% if display_name != object_name %}@{{display_name}},
        {% endif %}{{object_name}} is {{ states('sensor.'+printer+'_print_progress',
        with_unit=True)}} complete and on layer {{ states('sensor.'+printer+'_current_layer')
        }} of {{ states('sensor.'+printer+'_total_layer_count') }}. {{states('input_text.'+printer+'_stream')}}"
      data:
        username: '{{ printer | capitalize }}'
        icon: '{{ ''kiwifruit'' if printer == ''kiwi'' else printer }}'
    action: notify.make_nashville
  mode: single
- id: '1722144402850'
  alias: Lifecycle Print Starting
  description: ''
  triggers:
  - entity_id:
    - sensor.mango_print_status
    - sensor.kiwi_print_status
    - sensor.strawberry_print_status
    - sensor.papaya_print_status
    - sensor.huckleberry_print_status
    to:
    - running
    for:
      hours: 0
      minutes: 0
      seconds: 10
    trigger: state
    from:
    - prepare
  - entity_id:
    - sensor.pineapple_print_status
    to:
    - printing
    for:
      hours: 0
      minutes: 0
      seconds: 10
    trigger: state
  conditions: []
  actions:
  - variables:
      printer: '{{trigger.entity_id.split(''_'')[0].split(''.'')[1]}}'
      display_name: '{{states("sensor."+printer+"_display_name")}}'
      object_name: '{{states("sensor."+printer+"_object") }}'
      end_dt: '{% set e = as_datetime(states("sensor."+printer+"_end_time"), none)
        %}{% if e %}{{ e }}{% else %}{% set s = states("sensor."+printer+"_print_time_left")|int(0)
        %}{% if s > 0 %}{{ now() + timedelta(seconds=s) }}{% endif %}{% endif %}'
      print_weight: '{{states("sensor."+printer+"_print_weight", with_unit=True) if
        states("sensor."+printer+"_print_weight") not in ["unknown","unavailable",""]
        else ""}}'
      total_layers: '{{states("sensor."+printer+"_total_layer_count") if states("sensor."+printer+"_total_layer_count")
        not in ["unknown","unavailable",""] else states("sensor."+printer+"_total_layers")
        if states("sensor."+printer+"_total_layers") not in ["unknown","unavailable",""]
        else ""}}'
      bed_type: '{{states("sensor."+printer+"_print_bed_type") if states("sensor."+printer+"_print_bed_type")
        not in ["unknown","unavailable",""] else ""}}'
  - data:
      target: '#3dprint-info'
      message: "üéâ {% if display_name != object_name %}@{{display_name}},
        {% endif %}{{object_name}} is starting!{% if print_weight %} Printing {{print_weight}}{% endif
        %}{% if total_layers %} over {{total_layers}} layers{% endif %}{% if bed_type
        %} on a {{bed_type}}{% endif %}. Estimated duration {{time_until(end_dt)}}{%
        if end_dt %} (ends at {{ as_timestamp(end_dt) | timestamp_custom('%I:%M %p') }}){% endif
        %} {{states('input_text.'+printer+'_stream')}}"
      data:
        username: '{{ printer | capitalize }}'
        icon: '{{ ''kiwifruit'' if printer == ''kiwi'' else printer }}'
    action: notify.make_nashville
  mode: parallel
  max: 4
- id: '1722191155564'
  alias: Lifecycle Print Finished
  description: ''
  triggers:
  - entity_id:
    - sensor.mango_print_status
    - sensor.kiwi_print_status
    - sensor.strawberry_print_status
    - sensor.papaya_print_status
    - sensor.huckleberry_print_status
    to:
    - finish
    for:
      hours: 0
      minutes: 0
      seconds: 5
    trigger: state
    from:
    - running
  - entity_id:
    - sensor.pineapple_print_status
    to:
    - completed
    for:
      hours: 0
      minutes: 0
      seconds: 5
    trigger: state
    from:
    - printing
  conditions: []
  actions:
  - variables:
      printer: '{{trigger.entity_id.split(''_'')[0].split(''.'')[1]}}'
      display_name: '{{states("sensor."+printer+"_last_display_name") }}'
      object_name: '{{states("sensor."+printer+"_last_object") }}'
      job_secs: '{{states("sensor."+printer+"_print_job_time") | int(0)}}'
      job_time_str: '{%- set h = (job_secs // 3600) | int %}{%- set m = ((job_secs
        % 3600) // 60) | int %}{{ h }}h {{ "%02d" | format(m) }}m'
      used_weight: '{{states("sensor."+printer+"_used_material_weight", with_unit=True)
        if states("sensor."+printer+"_used_material_weight") not in ["unknown","unavailable"]
        else ""}}'
  - data:
      target: '#3dprint-info'
      message: ‚úÖ {% if display_name != object_name %}@{{display_name}}, {% endif %}{{object_name}}
        finished in {{job_time_str}}{% if used_weight %}, used {{used_weight}}{% endif
        %}! Please pick up your print and cleanup the space. {{states('input_text.'+printer+'_stream')}}
      data:
        username: '{{ printer | capitalize }}'
        icon: '{{ ''kiwifruit'' if printer == ''kiwi'' else printer }}'
    action: notify.make_nashville
  mode: parallel
  max: 4
- id: '1722194364076'
  alias: Lifecycle Print Stopped
  description: ''
  triggers:
  - entity_id:
    - sensor.mango_print_status
    - sensor.kiwi_print_status
    - sensor.strawberry_print_status
    - sensor.papaya_print_status
    - sensor.huckleberry_print_status
    to:
    - failed
    for:
      hours: 0
      minutes: 0
      seconds: 10
    trigger: state
    from:
    - running
  - entity_id:
    - sensor.pineapple_print_status
    to:
    - stopped
    for:
      hours: 0
      minutes: 0
      seconds: 10
    trigger: state
    from:
    - printing
  conditions: []
  actions:
  - variables:
      printer: '{{trigger.entity_id.split(''_'')[0].split(''.'')[1]}}'
      display_name: '{{states("sensor."+printer+"_display_name") }}'
      object_name: '{{states("sensor."+printer+"_object") }}'
      progress: '{{states("sensor."+printer+"_print_progress") | int(0)}}'
  - data:
      target: '#3dprint-info'
      message: '‚èπÔ∏è {% if display_name != object_name %}@{{display_name}}, {% endif
        %}{{object_name}} stopped at {{progress}}%. Check the print room for more
        details on what happened. {{states(''input_text.''+printer+''_stream'')}}'
      data:
        username: '{{ printer | capitalize }}'
        icon: '{{ ''kiwifruit'' if printer == ''kiwi'' else printer }}'
    action: notify.make_nashville
  mode: parallel
  max: 4
- id: '1740355200000'
  alias: Lifecycle Print Error
  description: ''
  triggers:
  - entity_id:
    - sensor.mango_print_status
    - sensor.kiwi_print_status
    - sensor.strawberry_print_status
    - sensor.papaya_print_status
    - sensor.huckleberry_print_status
    - sensor.pineapple_print_status
    to:
    - error
    for:
      hours: 0
      minutes: 0
      seconds: 10
    trigger: state
  conditions: []
  actions:
  - variables:
      printer: '{{trigger.entity_id.split(''_'')[0].split(''.'')[1]}}'
      display_name: '{{states("sensor."+printer+"_display_name") }}'
      object_name: '{{states("sensor."+printer+"_object") }}'
      error_info: '{{states("sensor."+printer+"_print_error") if states("sensor."+printer+"_print_error")
        not in ["unknown","unavailable",""] else ""}}'
  - data:
      target: '#3dprint-info'
      message: 'üö® {% if display_name != object_name %}@{{display_name}}, {% endif
        %}{{object_name}} encountered an error{% if error_info %}: {{error_info}}{%
        endif %}. Check the printer immediately. {{states(''input_text.''+printer+''_stream'')}}'
      data:
        username: '{{ printer | capitalize }}'
        icon: '{{ ''kiwifruit'' if printer == ''kiwi'' else printer }}'
    action: notify.make_nashville
  mode: parallel
  max: 4
- id: '1722445886802'
  alias: Roundup
  description: ''
  triggers:
  - hours: /2
    trigger: time_pattern
  conditions:
  - condition: template
    value_template: |-
      {% set printers = ['kiwi','mango','papaya','strawberry','huckleberry','pineapple'] %}
      {% set not_printing = ['unavailable','idle','offline','finish','failed','completed','stopped','error','unknown'] %}
      {% set ns = namespace(active=false) %}
      {% for p in printers %}{% if states('sensor.' ~ p ~ '_print_status') not in not_printing %}{% set ns.active = true %}{% endif %}{% endfor %}
      {{ ns.active }}
  actions:
  - data:
      target: '#3dprint-info'
      data:
        username: Fruitbasket
        icon: basket
      message: |-
        {%- set printers = [
          {"id":"kiwi","emoji":":kiwifruit:"},
          {"id":"mango","emoji":":mango:"},
          {"id":"papaya","emoji":":papaya:"},
          {"id":"strawberry","emoji":":strawberry:"},
          {"id":"huckleberry","emoji":":huckleberry:"},
          {"id":"pineapple","emoji":":pineapple:"},
        ] %}
        {%- set not_printing = ['unavailable','idle','offline','finish','failed','completed','stopped','error','unknown'] %}
        {%- set ns = namespace(active=0) %}
        {%- for p in printers %}
          {%- if states('sensor.' ~ p.id ~ '_print_status') not in not_printing %}
            {%- set ns.active = ns.active + 1 %}
          {%- endif %}
        {%- endfor %}
        {%- macro line(p) %}
          {%- set st = states('sensor.' ~ p.id ~ '_print_status') %}
          {%- set display = states('sensor.' ~ p.id ~ '_display_name') %}
          {%- set obj = states('sensor.' ~ p.id ~ '_object') %}
          {%- set display = p.id | capitalize if display in ['unknown','unavailable',''] else display %}
          {%- set obj = display if obj in ['unknown','unavailable',''] else obj %}
          {%- set status_labels = {
            'idle': 'Ready',
            'finish': 'Finished',
            'completed': 'Finished',
            'failed': 'Stopped',
            'stopped': 'Stopped',
            'error': 'Error',
            'pause': 'Paused',
            'paused': 'Paused',
            'offline': 'Offline',
            'unavailable': 'Offline',
            'unknown': 'Offline',
          } %}
          {%- if st not in not_printing %}
            {%- set progress = states('sensor.' ~ p.id ~ '_print_progress') %}
            {%- set end_dt = as_datetime(states('sensor.' ~ p.id ~ '_end_time'), none) %}
            {{- p.emoji }} @{{ display }} printing {{ obj }} ‚Äî {{ progress }}%{%- if end_dt %}, ends {{ as_timestamp(end_dt) | timestamp_custom('%I:%M %p') }}{%- endif %}
          {%- else %}
            {{- p.emoji }} {{ status_labels.get(st, st | capitalize) }}
          {%- endif %}
        {%- endmacro %}
        Bi-hourly roundup ‚Äî {{ ns.active }} printer{{ 's' if ns.active != 1 else '' }} active
        {%- for p in printers %}
        {{ line(p) }}
        {%- endfor %}
    action: notify.make_nashville
    enabled: true
  mode: single
- id: '1763702620736'
  alias: Kaeser Event notifier
  description: ''
  triggers:
  - type: voltage
    device_id: 475db66f7f774cdfa45430706b46ee05
    entity_id: a04620ed092035484c42bbc3ec1a8e07
    domain: sensor
    trigger: device
    above: 130
    for:
      hours: 0
      minutes: 2
      seconds: 0
  conditions: []
  actions:
  - action: notify.mobile_app_tim_krentz_iphone
    metadata: {}
    data:
      message: Kaeser Overpressurization Event!
  mode: single
- id: '1767137243013'
  alias: Stripe ‚Äì 3D Print Filament Purchase
  description: ''
  triggers:
  - webhook_id: stripe_payment_complete
    trigger: webhook
    allowed_methods:
    - POST
    - PUT
    local_only: false
  conditions:
  - condition: template
    value_template: '{% set desc = trigger.json.data.object.description %}

      {{ desc.startswith(''3D Print Filament ‚Äì Self Service'') }}

      '
    enabled: true
  actions:
  - action: light.turn_on
    metadata: {}
    target:
      entity_id: light.filament_store_light
    data:
      rgb_color:
      - 11
      - 199
      - 0
      brightness_pct: 100
  - delay:
      hours: 0
      minutes: 0
      seconds: 30
      milliseconds: 0
  - action: light.turn_on
    metadata: {}
    target:
      entity_id: light.filament_store_light
    data:
      rgb_color:
      - 255
      - 158
      - 0
      brightness_pct: 10
      transition: 32
  mode: single
- id: backup_config_github
  alias: Backup Config to GitHub
  description: Automatically backup HA config to GitHub
  triggers:
  - at: 03:00:00
    trigger: time
  actions:
  - sequence:
    - action: hassio.addon_stdin
      data:
        addon: core_ssh
        input: /config/git_backup.sh
  mode: single
- id: '1769271913348'
  alias: Facilities Temperature Alert
  description: ''
  triggers:
  - trigger: numeric_state
    entity_id:
    - sensor.air_quality_temperature
    - sensor.ceramics_climate_sensor_temperature
    - sensor.woodshop_climate_sensor_temperature
    - sensor.front_hallway_climate_sensor_temperature
    - sensor.network_closet_climate_sensor_temperature
    below: 60
    for:
      hours: 0
      minutes: 0
      seconds: 5
  conditions: []
  actions:
  - action: notify.make_nashville
    metadata: {}
    data:
      target: '#facilities-feed'
      data:
        icon: warning
        username: Alert
      message: '"{{ trigger.to_state.name }} is currently {{ trigger.to_state.state
        }}, it may continue to drop."'
  mode: single
- id: '1769288567041'
  alias: Facilities Pulse
  description: ''
  triggers:
  - trigger: time_pattern
    hours: /6
  conditions: []
  actions:
  - action: notify.make_nashville
    metadata: {}
    data:
      message: '```

        Area               Temp   Humidity

        ----------------------------------

        {% for device_id in label_devices(''facilities_pulse'') -%}

        {% set entities = device_entities(device_id) -%}

        {% set temp_entity = entities | reject(''search'', ''display_temperature'')
        | select(''search'', ''temperature'') | first | default(none) -%}

        {% set humidity_entity = entities | select(''search'', ''humidity'') | first
        | default(none) -%}

        {% if temp_entity and states(temp_entity) not in [''unknown'', ''unavailable'',
        none] -%}

        {% set area = area_name(temp_entity) | default(''Unknown'') -%}

        {{ "%-17s" | format(area) }} {{ "%5.1f¬∞F" | format(states(temp_entity) | float(0))
        }}  {{ states(humidity_entity) | float(0) | round(0) | int }}%

        {% endif -%}

        {% endfor -%}

        {{ "%-17s" | format(''Outside'') }} {{ "%5.1f¬∞F" | format(state_attr(''weather.forecast_home'',
        ''temperature'') | float(0)) }}  {{ state_attr(''weather.forecast_home'',
        ''humidity'') | int }}%


        Power:               {{ states(''sensor.total_power_alarm_power_failure_alarm'')
        | capitalize }}

        Executive Bathroom:  {{ state_translated(''binary_sensor.water_leak_sensor'')
        }}

        3D Print VOC Index:  {{ states(''sensor.air_quality_voc_index'') }}

        Kaeser Air Pressure: {{ states(''sensor.kaeser_monitor_system_pressure'')
        | float(0) | round(1) }} psi

        ```'
      data:
        icon: information_source
        username: Facilities Pulse
      target: '#facilities-feed'
  mode: single
- id: '1740400000000'
  alias: Gadget AI Failure Detection
  description: Receives OctoEverywhere Gadget webhooks for Bambu Lab printers
  triggers:
  - trigger: webhook
    webhook_id: octoeverywhere_gadget
    allowed_methods:
    - POST
    local_only: false
  conditions:
  - condition: template
    value_template: '{{ trigger.json.EventType in [7, 8] }}'
  actions:
  - variables:
      event_type: '{{ trigger.json.EventType }}'
      printer_name: '{{ trigger.json.PrinterName }}'
      printer_id: '{{ trigger.json.PrinterName | lower }}'
      file_name: '{{ trigger.json.FileName | default("") }}'
      progress: '{{ trigger.json.Progress | default(0) }}'
      quick_view_url: '{{ trigger.json.QuickViewUrl | default("") }}'
      stream_url: '{{ states("input_text." + printer_id + "_stream") }}'
  - action: notify.make_nashville
    data:
      target: '#3dprint-info'
      message: '{% if event_type == 8 %}üö® Gadget paused {{ printer_name }} after
        detecting a failure{% else %}‚ö†Ô∏è Gadget detected a possible failure on {{
        printer_name }}{% endif %}{% if file_name %} printing {{ file_name }}{% endif
        %} ({{ progress }}% complete).{% if quick_view_url %} {{ quick_view_url }}{%
        endif %} {{ stream_url }}'
      data:
        username: Gadget
        icon: robot_face
  mode: parallel
  max: 5
- id: '1769999000001'
  alias: Purge Kaeser Pressure History
  description: Keep only 3 days of Kaeser pressure data to limit DB growth
  triggers:
  - trigger: time
    at: '03:30:00'
  conditions: []
  actions:
  - action: recorder.purge_entities
    data:
      entity_id:
      - sensor.kaeser_monitor_system_pressure
      keep_days: 3
  mode: single
