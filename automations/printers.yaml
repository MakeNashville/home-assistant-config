- id: '1721495372161'
  alias: Lifecycle Print Progress
  triggers:
  - entity_id:
    - sensor.kiwi_current_layer
    - sensor.papaya_current_layer
    - sensor.mango_current_layer
    - sensor.strawberry_current_layer
    - sensor.huckleberry_current_layer
    - sensor.pineapple_current_layer
    for:
      seconds: 1
    to:
    - '2'
    trigger: state
  - entity_id:
    - sensor.kiwi_current_layer
    - sensor.papaya_current_layer
    - sensor.mango_current_layer
    - sensor.strawberry_current_layer
    - sensor.huckleberry_current_layer
    - sensor.pineapple_current_layer
    for:
      seconds: 1
    to:
    - '10'
    trigger: state
  - entity_id:
    - sensor.kiwi_print_progress
    - sensor.papaya_print_progress
    - sensor.mango_print_progress
    - sensor.strawberry_print_progress
    - sensor.huckleberry_print_progress
    - sensor.pineapple_print_progress
    for:
      seconds: 1
    to:
    - '50'
    trigger: state
  - entity_id:
    - sensor.kiwi_print_progress
    - sensor.papaya_print_progress
    - sensor.mango_print_progress
    - sensor.strawberry_print_progress
    - sensor.huckleberry_print_progress
    - sensor.pineapple_print_progress
    for:
      seconds: 1
    to:
    - '90'
    trigger: state
  actions:
  - variables:
      printer: '{{trigger.entity_id.split(''_'')[0].split(''.'')[1]}}'
      display_name: '{{states("sensor."+printer+"_display_name") }}'
      object_name: '{{states("sensor."+printer+"_object") }}'
  - data:
      target: "#3dprint-info"
      message: ":speech_balloon:{% if display_name != object_name %}@{{display_name}},
        {% endif %}{{object_name}} is {{ states('sensor.'+printer+'_print_progress',
        with_unit=True)}} complete and on layer {{ states('sensor.'+printer+'_current_layer')
        }} of {{ states('sensor.'+printer+'_total_layer_count') }}. {{states('input_text.'+printer+'_stream')}}"
      data:
        username: '{{ printer | capitalize }}'
        icon: '{{ ''kiwifruit'' if printer == ''kiwi'' else printer }}'
    action: notify.make_nashville
  mode: single
- id: '1722144402850'
  alias: Lifecycle Print Starting
  triggers:
  - entity_id: &bambu_lab_printers
    - sensor.mango_print_status
    - sensor.kiwi_print_status
    - sensor.strawberry_print_status
    - sensor.papaya_print_status
    - sensor.huckleberry_print_status
    to:
    - running
    for:
      seconds: 10
    trigger: state
    from:
    - prepare
  - entity_id:
    - sensor.pineapple_print_status
    to:
    - printing
    from:
    - idle
    for:
      seconds: 10
    trigger: state
  actions:
  - variables:
      printer: '{{trigger.entity_id.split(''_'')[0].split(''.'')[1]}}'
      display_name: '{{states("sensor."+printer+"_display_name")}}'
      object_name: '{{states("sensor."+printer+"_object") }}'
      end_dt: '{% set e = as_datetime(states("sensor."+printer+"_end_time"), none)
        %}{% if e %}{{ e }}{% else %}{% set s = states("sensor."+printer+"_print_time_left")|int(0)
        %}{% if s > 0 %}{{ now() + timedelta(seconds=s) }}{% endif %}{% endif %}'
      print_weight: '{{states("sensor."+printer+"_print_weight", with_unit=True) if
        states("sensor."+printer+"_print_weight") not in ["unknown","unavailable",""]
        else ""}}'
      total_layers: '{{states("sensor."+printer+"_total_layer_count") if states("sensor."+printer+"_total_layer_count")
        not in ["unknown","unavailable",""] else states("sensor."+printer+"_total_layers")
        if states("sensor."+printer+"_total_layers") not in ["unknown","unavailable",""]
        else ""}}'
      bed_type: '{{states("sensor."+printer+"_print_bed_type") if states("sensor."+printer+"_print_bed_type")
        not in ["unknown","unavailable",""] else ""}}'
  - data:
      target: "#3dprint-info"
      message: ":printer:{% if display_name != object_name %}@{{display_name}},
        {% endif %}{{object_name}} is starting!{% if print_weight %} Printing {{print_weight}}{% endif
        %}{% if total_layers %} over {{total_layers}} layers{% endif %}{% if bed_type
        %} on a {{bed_type}}{% endif %}.{% if end_dt %} {% set secs = (as_timestamp(end_dt)
        - as_timestamp(now())) | int(0) %}{% set h = secs // 3600 %}{% set m = (secs
        % 3600) // 60 %}{{ h }}h {{ '%02d' | format(m) }}m (ends at {{ as_timestamp(end_dt)
        | timestamp_custom('%I:%M %p') }}){% endif %} {{states('input_text.'+printer+'_stream')}}"
      data:
        username: '{{ printer | capitalize }}'
        icon: '{{ ''kiwifruit'' if printer == ''kiwi'' else printer }}'
    action: notify.make_nashville
  - if:
    - condition: template
      value_template: "{{ printer == 'pineapple' }}"
    then:
    - action: input_text.set_value
      target:
        entity_id: input_text.pineapple_last_job
      data:
        value: "{{ states('sensor.pineapple_current_object') }}"
  mode: parallel
  max: 4
- id: '1722191155564'
  alias: Lifecycle Print Finished
  triggers:
  - entity_id: *bambu_lab_printers
    to:
    - finish
    for:
      seconds: 5
    trigger: state
    from:
    - running
  - entity_id:
    - sensor.pineapple_print_status
    to:
    - completed
    for:
      seconds: 5
    trigger: state
    from:
    - printing
  actions:
  - variables:
      printer: '{{trigger.entity_id.split(''_'')[0].split(''.'')[1]}}'
      display_name: '{{states("sensor."+printer+"_last_display_name") }}'
      object_name: '{{states("sensor."+printer+"_last_object") }}'
      job_secs: '{{states("sensor."+printer+"_print_job_time") | int(0)}}'
      job_time_str: '{%- set h = (job_secs // 3600) | int %}{%- set m = ((job_secs
        % 3600) // 60) | int %}{{ h }}h {{ "%02d" | format(m) }}m'
      used_weight: '{{states("sensor."+printer+"_used_material_weight", with_unit=True)
        if states("sensor."+printer+"_used_material_weight") not in ["unknown","unavailable"]
        else ""}}'
  - data:
      target: "#3dprint-info"
      message: ":white_check_mark:{% if display_name != object_name %}@{{display_name}}, {% endif %}{{object_name}}
        finished in {{job_time_str}}{% if used_weight %}, used {{used_weight}}{% endif
        %}! Please pick up your print and cleanup the space. {{states('input_text.'+printer+'_stream')}}"
      data:
        username: '{{ printer | capitalize }}'
        icon: '{{ ''kiwifruit'' if printer == ''kiwi'' else printer }}'
    action: notify.make_nashville
  mode: parallel
  max: 4
- id: '1722194364076'
  alias: Lifecycle Print Stopped
  triggers:
  - entity_id: *bambu_lab_printers
    to:
    - failed
    for:
      seconds: 10
    trigger: state
    from:
    - running
  - entity_id:
    - sensor.pineapple_print_status
    to:
    - stopped
    for:
      seconds: 10
    trigger: state
    from:
    - printing
  actions:
  - variables:
      printer: '{{trigger.entity_id.split(''_'')[0].split(''.'')[1]}}'
      display_name: '{{states("sensor."+printer+"_display_name") }}'
      object_name: '{{states("sensor."+printer+"_object") }}'
      progress: '{{states("sensor."+printer+"_print_progress") | int(0)}}'
  - data:
      target: "#3dprint-info"
      message: ':stop_button:{% if display_name != object_name %}@{{display_name}}, {% endif
        %}{{object_name}} stopped at {{progress}}%. Check the print room for more
        details on what happened. {{states(''input_text.''+printer+''_stream'')}}'
      data:
        username: '{{ printer | capitalize }}'
        icon: '{{ ''kiwifruit'' if printer == ''kiwi'' else printer }}'
    action: notify.make_nashville
  mode: parallel
  max: 4
- id: '1740355200000'
  alias: Lifecycle Print Error
  triggers:
  - entity_id: &all_printers
    - sensor.mango_print_status
    - sensor.kiwi_print_status
    - sensor.strawberry_print_status
    - sensor.papaya_print_status
    - sensor.huckleberry_print_status
    - sensor.pineapple_print_status
    to:
    - error
    for:
      seconds: 10
    trigger: state
  actions:
  - variables:
      printer: '{{trigger.entity_id.split(''_'')[0].split(''.'')[1]}}'
      display_name: '{{states("sensor."+printer+"_display_name") }}'
      object_name: '{{states("sensor."+printer+"_object") }}'
      error_info: '{{states("sensor."+printer+"_print_error") if states("sensor."+printer+"_print_error")
        not in ["unknown","unavailable",""] else ""}}'
  - data:
      target: "#3dprint-info"
      message: ':rotating_light:{% if display_name != object_name %}@{{display_name}}, {% endif
        %}{{object_name}} encountered an error{% if error_info %}: {{error_info}}{%
        endif %}. Check the printer immediately. {{states(''input_text.''+printer+''_stream'')}}'
      data:
        username: '{{ printer | capitalize }}'
        icon: '{{ ''kiwifruit'' if printer == ''kiwi'' else printer }}'
    action: notify.make_nashville
  mode: parallel
  max: 4
- id: '1740400001000'
  alias: Lifecycle Print Paused
  triggers:
  - entity_id: *bambu_lab_printers
    to:
    - pause
    for:
      seconds: 10
    trigger: state
    from:
    - running
  - entity_id:
    - sensor.pineapple_print_status
    to:
    - paused
    for:
      seconds: 10
    trigger: state
    from:
    - printing
  actions:
  - variables:
      printer: '{{trigger.entity_id.split(''_'')[0].split(''.'')[1]}}'
      display_name: '{{states("sensor."+printer+"_display_name") }}'
      object_name: '{{states("sensor."+printer+"_object") }}'
      progress: '{{states("sensor."+printer+"_print_progress") | int(0)}}'
  - data:
      target: "#3dprint-info"
      message: ':double_vertical_bar:{% if display_name != object_name %}@{{display_name}}, {% endif
        %}{{object_name}} paused at {{progress}}%. {{states(''input_text.''+printer+''_stream'')}}'
      data:
        username: '{{ printer | capitalize }}'
        icon: '{{ ''kiwifruit'' if printer == ''kiwi'' else printer }}'
    action: notify.make_nashville
  mode: parallel
  max: 4
- id: '1722445886802'
  alias: Roundup
  triggers:
  - hours: /2
    trigger: time_pattern
  conditions:
  - condition: template
    value_template: "{{ now().hour >= 7 and now().hour < 22 }}"
  - condition: template
    value_template: |-
      {% set printers = ['kiwi','mango','papaya','strawberry','huckleberry','pineapple'] %}
      {% set not_printing = ['unavailable','idle','offline','finish','failed','completed','stopped','error','unknown','prepare'] %}
      {% set ns = namespace(active=false) %}
      {% for p in printers %}{% if states('sensor.' ~ p ~ '_print_status') not in not_printing %}{% set ns.active = true %}{% endif %}{% endfor %}
      {{ ns.active }}
  actions:
  - data:
      target: "#3dprint-info"
      data:
        username: Fruitbasket
        icon: basket
      message: |-
        {%- set printers = [
          {"id":"kiwi","emoji":":kiwifruit:"},
          {"id":"mango","emoji":":mango:"},
          {"id":"papaya","emoji":":papaya:"},
          {"id":"strawberry","emoji":":strawberry:"},
          {"id":"huckleberry","emoji":":huckleberry:"},
          {"id":"pineapple","emoji":":pineapple:"},
        ] %}
        {%- set not_printing = ['unavailable','idle','offline','finish','failed','completed','stopped','error','unknown','prepare'] %}
        {%- set ns = namespace(active=0) %}
        {%- for p in printers %}
          {%- if states('sensor.' ~ p.id ~ '_print_status') not in not_printing %}
            {%- set ns.active = ns.active + 1 %}
          {%- endif %}
        {%- endfor %}
        {%- macro line(p) %}
          {%- set st = states('sensor.' ~ p.id ~ '_print_status') %}
          {%- set display = states('sensor.' ~ p.id ~ '_display_name') %}
          {%- set obj = states('sensor.' ~ p.id ~ '_object') %}
          {%- set display = p.id | capitalize if display in ['unknown','unavailable',''] else display %}
          {%- set obj = display if obj in ['unknown','unavailable',''] else obj %}
          {%- set status_labels = {
            'idle': 'Ready',
            'prepare': 'Preparing',
            'finish': 'Finished',
            'completed': 'Finished',
            'failed': 'Stopped',
            'stopped': 'Stopped',
            'error': 'Error',
            'pause': 'Paused',
            'paused': 'Paused',
            'offline': 'Offline',
            'unavailable': 'Offline',
            'unknown': 'Offline',
          } %}
          {%- if st not in not_printing %}
            {%- set progress = states('sensor.' ~ p.id ~ '_print_progress') %}
            {%- set _end_raw = as_datetime(states('sensor.' ~ p.id ~ '_end_time'), none) %}
            {%- set _tl = states('sensor.' ~ p.id ~ '_print_time_left') | int(0) %}
            {%- set end_dt = _end_raw if _end_raw else (now() + timedelta(seconds=_tl) if _tl > 0 else none) %}
            {%- set verb = 'paused on' if st in ['pause', 'paused'] else 'printing' %}
            {{- p.emoji }} @{{ display }} {{ verb }} {{ obj }} — {{ progress }}%{%- if end_dt %}, ends {{ as_timestamp(end_dt) | timestamp_custom('%I:%M %p') }}{%- endif %}
          {%- else %}
            {{- p.emoji }} {{ status_labels.get(st, st | capitalize) }}
          {%- endif %}
        {%- endmacro %}
        Bi-hourly roundup — {{ ns.active }} printer{{ 's' if ns.active != 1 else '' }} active
        {%- for p in printers %}
        {{ line(p) }}
        {%- endfor %}
    action: notify.make_nashville
    enabled: true
  mode: single
- id: '1740500000001'
  alias: Lifecycle Printer Offline
  triggers:
  - entity_id: *all_printers
    to:
    - unavailable
    for:
      minutes: 5
    trigger: state
  actions:
  - variables:
      printer: '{{trigger.entity_id.split(''_'')[0].split(''.'')[1]}}'
  - data:
      target: "#3dprint-info"
      message: ':warning: {{ printer | capitalize }} has gone offline.'
      data:
        username: '{{ printer | capitalize }}'
        icon: '{{ ''kiwifruit'' if printer == ''kiwi'' else printer }}'
    action: notify.make_nashville
  mode: parallel
  max: 6
- id: '1740600000001'
  alias: Weekly Print Summary
  description: Posts 7-day print totals to #3dprint-info every Sunday at 9am
  triggers:
  - trigger: time
    at: '09:00:00'
  conditions:
  - condition: template
    value_template: '{{ now().weekday() == 6 }}'
  actions:
  - action: notify.make_nashville
    data:
      target: "#3dprint-info"
      data:
        username: Fruitbasket
        icon: basket
      message: |-
        {%- set printers = [
          {"id":"kiwi","emoji":":kiwifruit:"},
          {"id":"mango","emoji":":mango:"},
          {"id":"papaya","emoji":":papaya:"},
          {"id":"strawberry","emoji":":strawberry:"},
          {"id":"huckleberry","emoji":":huckleberry:"},
          {"id":"pineapple","emoji":":pineapple:"},
        ] %}
        {%- set ns = namespace(total_ok=0, total_fail=0) %}
        :bar_chart: Weekly Print Summary (last 7 days)
        {%- for p in printers %}
          {%- set ok = states('sensor.' ~ p.id ~ '_prints_completed_week') | int(0) %}
          {%- set fail = states('sensor.' ~ p.id ~ '_prints_failed_week') | int(0) %}
          {%- set ns.total_ok = ns.total_ok + ok %}
          {%- set ns.total_fail = ns.total_fail + fail %}
        {{ p.emoji }} {{ p.id | capitalize }}: {{ ok }} :white_check_mark:  {{ fail }} :x:
        {%- endfor %}
        ──────────────────────
        Total: {{ ns.total_ok }} :white_check_mark:  {{ ns.total_fail }} :x:
  mode: single
- id: lifecycle_multi_printer_offline
  alias: Lifecycle Multi-Printer Offline — Network/Power Alert
  triggers:
  - entity_id: *all_printers
    to:
    - unavailable
    for:
      minutes: 5
    trigger: state
  conditions:
  - condition: template
    value_template: >
      {% set printers = ['kiwi','mango','papaya','strawberry','huckleberry','pineapple'] %}
      {% set ns = namespace(offline=0) %}
      {% for p in printers %}
        {% if states('sensor.' ~ p ~ '_print_status') in ['unavailable','unknown','offline'] %}
          {% set ns.offline = ns.offline + 1 %}
        {% endif %}
      {% endfor %}
      {{ ns.offline >= 3 }}
  actions:
  - action: notify.make_nashville
    data:
      target: "#facilities-feed"
      message: >
        {% set printers = ['kiwi','mango','papaya','strawberry','huckleberry','pineapple'] %}
        {% set ns = namespace(offline=0, names=[]) %}
        {% for p in printers %}
          {% if states('sensor.' ~ p ~ '_print_status') in ['unavailable','unknown','offline'] %}
            {% set ns.offline = ns.offline + 1 %}
            {% set ns.names = ns.names + [p | capitalize] %}
          {% endif %}
        {% endfor %}
        :warning: {{ ns.offline }} printers offline simultaneously — possible network or power issue.
        Offline: {{ ns.names | join(', ') }}
      data:
        username: Fruitbasket
        icon: warning
  mode: single
