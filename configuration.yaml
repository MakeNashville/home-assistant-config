# Loads default set of integrations. Do not remove.
default_config:

# Load frontend themes from the themes folder
frontend:
  themes: !include_dir_merge_named themes

automation: !include_dir_merge_list automations

homeassistant:
  allowlist_external_dirs:
    - "/config/www/snapshots"

lovelace:
  dashboards:
    air-quality:
      mode: yaml
      title: Air Quality
      icon: mdi:air-filter
      filename: dashboards/air_quality.yaml
      show_in_sidebar: true
      require_admin: false
    facilities-overview:
      mode: yaml
      title: Facilities
      icon: mdi:office-building-cog
      filename: dashboards/facilities.yaml
      show_in_sidebar: true
      require_admin: false

python_script:

shell_command:
  git_pull: "git -C /config pull --rebase origin main"
  clear_entity_list: "truncate -s 0 /config/entity_list.txt"

input_text:
  pineapple_last_job:
    name: Pineapple Last Job
    max: 255

input_boolean:
  facilities_pulse_verbose:
    name: Facilities Pulse Verbose Mode
    icon: mdi:bell-outline

recorder:
  purge_keep_days: 14
  exclude:
    domains:
      - camera
      - device_tracker
      - image
      - person
      - weather
    entities:
      - sun.sun
      - binary_sensor.filament_store_light_motion
      - sensor.filament_store_light_illuminance
      - input_boolean.facilities_pulse_verbose
    entity_globs:
      # Fan speeds / signals (already present)
      - sensor.*_wi_fi_signal
      - sensor.*_fan_speed
      - sensor.*_target_temperature
      - sensor.*_speed_profile
      - sensor.*_current_layer_height
      - sensor.*_ams_tray_*
      # 3D printer real-time sensors
      - sensor.*_bed_temperature
      - sensor.*_position_*
      - sensor.*_ams_*
      - sensor.*_current_layer
      - sensor.*_remaining_time
      - sensor.*_model_download
      - sensor.*_print_progress
      - sensor.*_print_time_left
      - sensor.*_real_time_flow
      - sensor.*_current_object
      # Fans
      - fan.*_fan
      # Distance / proximity sensors
      - sensor.*_estimated_distance*

template:
  - sensor:
      - name: "Air Quality Overall Status"
        unique_id: air_quality_overall_status
        availability: >
          {{ states('sensor.air_quality_carbon_dioxide') not in ['unknown', 'unavailable']
             and states('sensor.air_quality_voc_index') not in ['unknown', 'unavailable']
             and states('sensor.air_quality_pm2_5') not in ['unknown', 'unavailable'] }}
        state: >
          {% set co2  = states('sensor.air_quality_carbon_dioxide') | int(0) %}
          {% set voc  = states('sensor.air_quality_voc_index')      | int(0) %}
          {% set nox  = states('sensor.air_quality_nox_index')      | int(0) %}
          {% set pm25 = states('sensor.air_quality_pm2_5')          | float(0) %}
          {% if co2 > 1500 or voc > 300 or nox > 250 or pm25 > 55.4 %}Dangerous
          {% elif co2 > 1200 or voc > 200 or nox > 150 or pm25 > 35.4 %}Poor
          {% elif co2 > 800  or voc > 150 or nox > 50  or pm25 > 12 %}Moderate
          {% else %}Good{% endif %}

      - name: "Kiwi Display Name"
        unique_id: kiwi_display_name
        availability: "{{ states('sensor.kiwi_gcode_filename') not in ['unknown', 'unavailable'] }}"
        state: >
          {{states('sensor.kiwi_gcode_filename').split('-')[0]}}
      - name: "Kiwi Object"
        unique_id: kiwi_object
        availability: "{{ states('sensor.kiwi_display_name') not in ['unknown', 'unavailable'] }}"
        state: >
          {{states('sensor.kiwi_gcode_filename').replace(states('sensor.kiwi_display_name') + '-', '')}}
      - name: "Kiwi Last Display Name"
        unique_id: kiwi_last_display_name
        availability: "{{ states('sensor.kiwi_task_name') not in ['unknown', 'unavailable'] }}"
        state: >
          {{states('sensor.kiwi_task_name').split('-')[0]}}
      - name: "Kiwi Last Object"
        unique_id: kiwi_last_object
        availability: "{{ states('sensor.kiwi_last_display_name') not in ['unknown', 'unavailable'] }}"
        state: >
          {{states('sensor.kiwi_task_name').replace(states('sensor.kiwi_last_display_name') + '-', '')}}
      - name: "Mango Display Name"
        unique_id: mango_display_name
        availability: "{{ states('sensor.mango_gcode_filename') not in ['unknown', 'unavailable'] }}"
        state: >
          {{states('sensor.mango_gcode_filename').split('-')[0]}}
      - name: "Mango Object"
        unique_id: mango_object
        availability: "{{ states('sensor.mango_display_name') not in ['unknown', 'unavailable'] }}"
        state: >
          {{states('sensor.mango_gcode_filename').replace(states('sensor.mango_display_name') + '-', '')}}
      - name: "Mango Last Display Name"
        unique_id: mango_last_display_name
        availability: "{{ states('sensor.mango_task_name') not in ['unknown', 'unavailable'] }}"
        state: >
          {{states('sensor.mango_task_name').split('-')[0]}}
      - name: "Mango Last Object"
        unique_id: mango_last_object
        availability: "{{ states('sensor.mango_last_display_name') not in ['unknown', 'unavailable'] }}"
        state: >
          {{states('sensor.mango_task_name').replace(states('sensor.mango_last_display_name') + '-', '')}}
      - name: "Papaya Display Name"
        unique_id: papaya_display_name
        availability: "{{ states('sensor.papaya_gcode_filename') not in ['unknown', 'unavailable'] }}"
        state: >
          {{states('sensor.papaya_gcode_filename').split('-')[0]}}
      - name: "Papaya Object"
        unique_id: papaya_object
        availability: "{{ states('sensor.papaya_display_name') not in ['unknown', 'unavailable'] }}"
        state: >
          {{states('sensor.papaya_gcode_filename').replace(states('sensor.papaya_display_name') + '-', '')}}
      - name: "Papaya Last Display Name"
        unique_id: papaya_last_display_name
        availability: "{{ states('sensor.papaya_task_name') not in ['unknown', 'unavailable'] }}"
        state: >
          {{states('sensor.papaya_task_name').split('-')[0]}}
      - name: "Papaya Last Object"
        unique_id: papaya_last_object
        availability: "{{ states('sensor.papaya_last_display_name') not in ['unknown', 'unavailable'] }}"
        state: >
          {{states('sensor.papaya_task_name').replace(states('sensor.papaya_last_display_name') + '-', '')}}
      - name: "Strawberry Display Name"
        unique_id: strawberry_display_name
        availability: "{{ states('sensor.strawberry_gcode_filename') not in ['unknown', 'unavailable'] }}"
        state: >
          {{states('sensor.strawberry_gcode_filename').split('-')[0]}}
      - name: "Strawberry Object"
        unique_id: strawberry_object
        availability: "{{ states('sensor.strawberry_display_name') not in ['unknown', 'unavailable'] }}"
        state: >
          {{states('sensor.strawberry_gcode_filename').replace(states('sensor.strawberry_display_name') + '-', '')}}
      - name: "Strawberry Last Display Name"
        unique_id: strawberry_last_display_name
        availability: "{{ states('sensor.strawberry_task_name') not in ['unknown', 'unavailable'] }}"
        state: >
          {{states('sensor.strawberry_task_name').split('-')[0]}}
      - name: "Strawberry Last Object"
        unique_id: strawberry_last_object
        availability: "{{ states('sensor.strawberry_last_display_name') not in ['unknown', 'unavailable'] }}"
        state: >
          {{states('sensor.strawberry_task_name').replace(states('sensor.strawberry_last_display_name') + '-', '')}}
      - name: "Huckleberry Display Name"
        unique_id: huckleberry_display_name
        availability: "{{ states('sensor.huckleberry_gcode_filename') not in ['unknown', 'unavailable'] }}"
        state: >
          {{states('sensor.huckleberry_gcode_filename').split('-')[0]}}
      - name: "Huckleberry Object"
        unique_id: huckleberry_object
        availability: "{{ states('sensor.huckleberry_display_name') not in ['unknown', 'unavailable'] }}"
        state: >
          {{states('sensor.huckleberry_gcode_filename').replace(states('sensor.huckleberry_display_name') + '-', '')}}
      - name: "Huckleberry Last Display Name"
        unique_id: huckleberry_last_display_name
        availability: "{{ states('sensor.huckleberry_task_name') not in ['unknown', 'unavailable'] }}"
        state: >
          {{states('sensor.huckleberry_task_name').split('-')[0]}}
      - name: "Huckleberry Last Object"
        unique_id: huckleberry_last_object
        availability: "{{ states('sensor.huckleberry_last_display_name') not in ['unknown', 'unavailable'] }}"
        state: >
          {{states('sensor.huckleberry_task_name').replace(states('sensor.huckleberry_last_display_name') + '-', '')}}

      - name: "Pineapple Display Name"
        unique_id: pineapple_display_name
        availability: "{{ states('sensor.pineapple_current_object') not in ['unknown', 'unavailable'] }}"
        state: >
          {{states('sensor.pineapple_current_object').split('-')[0]}}
      - name: "Pineapple Object"
        unique_id: pineapple_object
        availability: "{{ states('sensor.pineapple_display_name') not in ['unknown', 'unavailable'] }}"
        state: >
          {{states('sensor.pineapple_current_object').replace(states('sensor.pineapple_display_name') + '-', '')}}
      - name: "Pineapple Last Display Name"
        unique_id: pineapple_last_display_name
        state: >
          {{states('input_text.pineapple_last_job').split('-')[0]}}
      - name: "Pineapple Last Object"
        unique_id: pineapple_last_object
        availability: "{{ states('sensor.pineapple_last_display_name') not in ['unknown', 'unavailable'] }}"
        state: >
          {{states('input_text.pineapple_last_job').replace(states('sensor.pineapple_last_display_name') + '-', '')}}

      - name: "Dragonfruit Display Name"
        unique_id: dragonfruit_display_name
        availability: "{{ states('sensor.dragonfruit_filename') not in ['unknown', 'unavailable'] }}"
        state: >
          {{states('sensor.dragonfruit_filename').split('-')[0]}}
      - name: "Dragonfruit Object"
        unique_id: dragonfruit_object
        availability: "{{ states('sensor.dragonfruit_display_name') not in ['unknown', 'unavailable'] }}"
        state: >
          {{states('sensor.dragonfruit_filename').replace(states('sensor.dragonfruit_display_name') + '-', '')}}

sensor:
  # Weekly print counts â€” used by the Sunday metrics automation
  - platform: history_stats
    name: Kiwi Prints Completed Week
    entity_id: sensor.kiwi_print_status
    state: "finish"
    type: count
    start: "{{ now() - timedelta(days=7) }}"
    end: "{{ now() }}"
  - platform: history_stats
    name: Kiwi Prints Failed Week
    entity_id: sensor.kiwi_print_status
    state:
      - "failed"
      - "error"
    type: count
    start: "{{ now() - timedelta(days=7) }}"
    end: "{{ now() }}"
  - platform: history_stats
    name: Mango Prints Completed Week
    entity_id: sensor.mango_print_status
    state: "finish"
    type: count
    start: "{{ now() - timedelta(days=7) }}"
    end: "{{ now() }}"
  - platform: history_stats
    name: Mango Prints Failed Week
    entity_id: sensor.mango_print_status
    state:
      - "failed"
      - "error"
    type: count
    start: "{{ now() - timedelta(days=7) }}"
    end: "{{ now() }}"
  - platform: history_stats
    name: Papaya Prints Completed Week
    entity_id: sensor.papaya_print_status
    state: "finish"
    type: count
    start: "{{ now() - timedelta(days=7) }}"
    end: "{{ now() }}"
  - platform: history_stats
    name: Papaya Prints Failed Week
    entity_id: sensor.papaya_print_status
    state:
      - "failed"
      - "error"
    type: count
    start: "{{ now() - timedelta(days=7) }}"
    end: "{{ now() }}"
  - platform: history_stats
    name: Strawberry Prints Completed Week
    entity_id: sensor.strawberry_print_status
    state: "finish"
    type: count
    start: "{{ now() - timedelta(days=7) }}"
    end: "{{ now() }}"
  - platform: history_stats
    name: Strawberry Prints Failed Week
    entity_id: sensor.strawberry_print_status
    state:
      - "failed"
      - "error"
    type: count
    start: "{{ now() - timedelta(days=7) }}"
    end: "{{ now() }}"
  - platform: history_stats
    name: Huckleberry Prints Completed Week
    entity_id: sensor.huckleberry_print_status
    state: "finish"
    type: count
    start: "{{ now() - timedelta(days=7) }}"
    end: "{{ now() }}"
  - platform: history_stats
    name: Huckleberry Prints Failed Week
    entity_id: sensor.huckleberry_print_status
    state:
      - "failed"
      - "error"
    type: count
    start: "{{ now() - timedelta(days=7) }}"
    end: "{{ now() }}"
  - platform: history_stats
    name: Pineapple Prints Completed Week
    entity_id: sensor.pineapple_print_status
    state: "completed"
    type: count
    start: "{{ now() - timedelta(days=7) }}"
    end: "{{ now() }}"
  - platform: history_stats
    name: Pineapple Prints Failed Week
    entity_id: sensor.pineapple_print_status
    state: "stopped"
    type: count
    start: "{{ now() - timedelta(days=7) }}"
    end: "{{ now() }}"
